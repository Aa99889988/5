<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>WebRTC SIP 测试</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jssip/3.9.0/jssip.min.js"></script>
</head>
<body>
  <h2>WebRTC 测试</h2>
  <button onclick="register()">注册分机</button>
  <button onclick="call()">呼叫10010</button>
  <button onclick="hangup()">挂断</button>

  <script>
    let ua, session;

    function register() {
      const socket = new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
      const configuration = {
        sockets: [socket],
        uri: 'sip:898899@xin.anjre.cn',
        password: 'Aa14725836900@',
        display_name: '网页分机',
        session_timers: false
      };

      ua = new JsSIP.UA(configuration);

      ua.on('registered', () => console.log('✅ 已注册成功'));
      ua.on('registrationFailed', (e) => console.error('❌ 注册失败', e));
      ua.on('newRTCSession', (data) => {
        session = data.session;
        session.on('ended', () => console.log('📞 通话结束'));
        session.on('accepted', () => console.log('📞 通话已接通'));
      });

      ua.start();
    }

    function call() {
      if (!ua) return alert('请先注册');
      const eventHandlers = {
        failed: function(e) { console.log('呼叫失败', e); },
        ended: function(e) { console.log('通话结束'); },
        confirmed: function(e) { console.log('通话已接通'); }
      };

      const options = {
        eventHandlers,
        mediaConstraints: { audio: true, video: false }
      };

      session = ua.call('sip:10010@xin.anjre.cn', options);
    }

    function hangup() {
      if (session) session.terminate();
    }
  </script>
</body>
</html>
