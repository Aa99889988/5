!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>WebRTC SIP æµ‹è¯•</title>
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>
</head>
<body>
  <h2>WebRTC æµ‹è¯•</h2>

  <!-- å®¢æˆ·å¡«å†™ä¿¡æ¯ -->
  <label>å§“å: <input type="text" id="callerName" placeholder="è¯·è¾“å…¥å§“å" /></label><br />
  <label>æ‰‹æœºå·: <input type="text" id="callerNumber" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" /></label><br /><br />

  <!-- æ§åˆ¶æŒ‰é’® -->
  <button onclick="register()">æ³¨å†Œåˆ†æœº</button>
  <button onclick="call()">å‘¼å«å®¢æœ</button>
  <button onclick="hangup()">æŒ‚æ–­</button>

  <!-- éŸ³é¢‘æ’­æ”¾ -->
  <audio id="remoteAudio" autoplay playsinline></audio>

  <script>
    let ua, session;

    function register() {
      const socket = new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');

      // è·å–ç”¨æˆ·å¡«å†™çš„å§“åå’Œå·ç 
      const callerName = document.getElementById('callerName').value || 'ç½‘é¡µå®¢æˆ·';
      const callerNumber = document.getElementById('callerNumber').value || '000000';

      const configuration = {
        sockets: [socket],
        uri: 'sip:1008600@xin.anjre.cn',
        password: 'Aa6363463',
        display_name: `${callerName} ${callerNumber}`,  // ğŸ‘ˆ ä¼ å…¥æ¥ç”µæ˜¾ç¤º
        session_timers: false
      };

      ua = new JsSIP.UA(configuration);

      ua.on('registered', () => console.log('âœ… å·²æ³¨å†ŒæˆåŠŸ'));
      ua.on('registrationFailed', (e) => console.error('âŒ æ³¨å†Œå¤±è´¥', e));
      ua.on('newRTCSession', (data) => {
        session = data.session;

        session.on('ended', () => console.log('ğŸ“ é€šè¯ç»“æŸ'));
        session.on('accepted', () => console.log('ğŸ“ é€šè¯å·²æ¥é€š'));

        session.on('peerconnection', (e) => {
          const peerconnection = e.peerconnection;

          peerconnection.addEventListener('track', (event) => {
            const remoteStream = event.streams[0];
            const remoteAudio = document.getElementById('remoteAudio');
            remoteAudio.srcObject = remoteStream;
          });
        });
      });

      ua.start();
    }

    function call() {
      if (!ua) return alert('è¯·å…ˆæ³¨å†Œ');

      const eventHandlers = {
        failed: function(e) { console.log('å‘¼å«å¤±è´¥', e); },
        ended: function(e) { console.log('é€šè¯ç»“æŸ'); },
        confirmed: function(e) { console.log('é€šè¯å·²æ¥é€š'); }
      };

      const options = {
        eventHandlers,
        mediaConstraints: { audio: true, video: false }
      };

      // æ‹¨æ‰“å®¢æœåˆ†æœº 6666
      session = ua.call('sip:6666@xin.anjre.cn', options);
    }

    function hangup() {
      if (session) session.terminate();
    }
  </script>
</body>
</html>
