<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ç½‘é¡µå‘¼å« SIP å®¢æœ</title>
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: sans-serif;
      background-color: #f5f5f5;
    }
    h2 {
      margin-bottom: 20px;
    }
    button {
      padding: 12px 24px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
    }
    #status {
      margin-top: 20px;
      font-size: 16px;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>ç‚¹å‡»æŒ‰é’®å‘¼å«å®¢æœ</h2>
  <button id="callBtn">ğŸ“ å‘¼å«å®¢æœ</button>
  <button id="hangupBtn" style="display:none;">âŒ æŒ‚æ–­</button>
  <div id="status">çŠ¶æ€ï¼šæœªè¿æ¥</div>
  <audio id="audioRemote" autoplay></audio>

  <script>
    const socket = new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
    const configuration = {
      sockets: [socket],
      uri: 'sip:100110@xin.anjre.cn',
      password: 'Aa6363463@',
      display_name: 'ç½‘é¡µå®¢æˆ·',
      session_timers: false,
      register: true
    };

    const ua = new JsSIP.UA(configuration);
    let currentSession = null;

    const callBtn = document.getElementById('callBtn');
    const hangupBtn = document.getElementById('hangupBtn');
    const statusDiv = document.getElementById('status');
    const audioRemote = document.getElementById('audioRemote');

    ua.on('connected', () => {
      console.log('å·²è¿æ¥åˆ° SIP WebSocket');
      statusDiv.textContent = 'çŠ¶æ€ï¼šå·²è¿æ¥';
    });

    ua.on('registered', () => {
      console.log('âœ… æ³¨å†ŒæˆåŠŸ');
      statusDiv.textContent = 'çŠ¶æ€ï¼šå·²æ³¨å†Œ';
    });

    ua.on('registrationFailed', (e) => {
      console.error('âŒ æ³¨å†Œå¤±è´¥', e);
      statusDiv.textContent = 'çŠ¶æ€ï¼šæ³¨å†Œå¤±è´¥';
    });

    ua.on('disconnected', () => {
      console.log('â— WebSocket æ–­å¼€');
      statusDiv.textContent = 'çŠ¶æ€ï¼šå·²æ–­å¼€';
    });

    ua.start();

    callBtn.addEventListener('click', () => {
      if (currentSession) {
        console.warn('å·²æœ‰é€šè¯è¿›è¡Œä¸­');
        return;
      }

      const session = ua.call('sip:9901@xin.anjre.cn', {
        mediaConstraints: { audio: true, video: false }
      });

      currentSession = session;

      session.on('peerconnection', function(e) {
        const pc = e.peerconnection;
        if ('ontrack' in pc) {
          pc.ontrack = function(event) {
            if (event.streams && event.streams[0]) {
              audioRemote.srcObject = event.streams[0];
            }
          };
        } else {
          pc.onaddstream = function(event) {
            audioRemote.srcObject = event.stream;
          };
        }
      });

      session.on('progress', () => {
        console.log('ğŸ“ æŒ¯é“ƒä¸­...');
        statusDiv.textContent = 'çŠ¶æ€ï¼šæŒ¯é“ƒä¸­...';
      });

      session.on('accepted', () => {
        console.log('âœ… é€šè¯å·²æ¥å¬');
        statusDiv.textContent = 'çŠ¶æ€ï¼šé€šè¯ä¸­';
        hangupBtn.style.display = 'inline-block';
      });

      session.on('ended', () => {
        console.log('ğŸ›‘ é€šè¯ç»“æŸ');
        statusDiv.textContent = 'çŠ¶æ€ï¼šé€šè¯å·²ç»“æŸ';
        hangupBtn.style.display = 'none';
        currentSession = null;
      });

      session.on('failed', (e) => {
        console.error('âŒ å‘¼å«å¤±è´¥', e);
        statusDiv.textContent = 'çŠ¶æ€ï¼šå‘¼å«å¤±è´¥';
        hangupBtn.style.display = 'none';
        currentSession = null;
      });
    });

    hangupBtn.addEventListener('click', () => {
      if (currentSession) {
        currentSession.terminate();
        currentSession = null;
        statusDiv.textContent = 'çŠ¶æ€ï¼šé€šè¯å·²æŒ‚æ–­';
        hangupBtn.style.display = 'none';
      }
    });
  </script>
</body>
</html>
