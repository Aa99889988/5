<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>å®¢æˆ·é€šè¯é¡µé¢</title>
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>
</head>
<body>
  <h2>è¯·è¾“å…¥æ‚¨çš„ä¿¡æ¯</h2>

  <label>å§“åï¼š</label>
  <input type="text" id="name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" /><br><br>

  <label>æ‰‹æœºå·ï¼š</label>
  <input type="text" id="phone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·" /><br><br>

  <button onclick="startCall()">å¼€å§‹é€šè¯</button>
  <button onclick="hangup()">æŒ‚æ–­</button>

  <audio id="remoteAudio" autoplay playsinline></audio>

  <script>
    let ua, session;

    function startCall() {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();

      if (!name || !phone) {
        alert('è¯·å¡«å†™å§“åå’Œæ‰‹æœºå·');
        return;
      }

      const displayName = `${name} ${phone}`;
      const socket = new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
      const configuration = {
        sockets: [socket],
        uri: 'sip:1008600@xin.anjre.cn',
        password: 'Aa6363463',
        display_name: displayName,
        session_timers: false
      };

      ua = new JsSIP.UA(configuration);

      ua.on('registered', () => {
        console.log('âœ… å·²æ³¨å†ŒæˆåŠŸï¼Œå‡†å¤‡å‘¼å«');
        makeCall();
      });

      ua.on('registrationFailed', (e) => {
        console.error('âŒ æ³¨å†Œå¤±è´¥', e);
      });

      ua.on('newRTCSession', (data) => {
        session = data.session;

        session.on('accepted', () => console.log('ğŸ“ é€šè¯å·²æ¥é€š'));
        session.on('ended', () => console.log('ğŸ“ é€šè¯ç»“æŸ'));

        session.on('peerconnection', (e) => {
          e.peerconnection.addEventListener('track', (event) => {
            document.getElementById('remoteAudio').srcObject = event.streams[0];
          });
        });
      });

      ua.start();
    }

    function makeCall() {
      const options = {
        mediaConstraints: { audio: true, video: false }
      };

      session = ua.call('sip:6666@xin.anjre.cn', options);
    }

    function hangup() {
      if (session) session.terminate();
    }
  </script>
</body>
</html>
