<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>网页呼叫 SIP 客服</title>
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: sans-serif;
      background-color: #f5f5f5;
    }
    h2 {
      margin-bottom: 20px;
    }
    button {
      padding: 12px 24px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
    }
    #status {
      margin-top: 20px;
      font-size: 16px;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>点击按钮呼叫客服</h2>
  <button id="callBtn">📞 呼叫客服</button>
  <button id="hangupBtn" style="display:none;">❌ 挂断</button>
  <div id="status">状态：未连接</div>
  <audio id="audioRemote" autoplay></audio>

  <script>
    const socket = new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
    const configuration = {
      sockets: [socket],
      uri: 'sip:100110@xin.anjre.cn',
      password: 'Aa6363463@',
      display_name: '网页客户',
      session_timers: false,
      register: true
    };

    const ua = new JsSIP.UA(configuration);
    let currentSession = null;

    const callBtn = document.getElementById('callBtn');
    const hangupBtn = document.getElementById('hangupBtn');
    const statusDiv = document.getElementById('status');
    const audioRemote = document.getElementById('audioRemote');

    ua.on('connected', () => {
      console.log('已连接到 SIP WebSocket');
      statusDiv.textContent = '状态：已连接';
    });

    ua.on('registered', () => {
      console.log('✅ 注册成功');
      statusDiv.textContent = '状态：已注册';
    });

    ua.on('registrationFailed', (e) => {
      console.error('❌ 注册失败', e);
      statusDiv.textContent = '状态：注册失败';
    });

    ua.on('disconnected', () => {
      console.log('❗ WebSocket 断开');
      statusDiv.textContent = '状态：已断开';
    });

    ua.start();

    callBtn.addEventListener('click', () => {
      if (currentSession) {
        console.warn('已有通话进行中');
        return;
      }

      const session = ua.call('sip:9901@xin.anjre.cn', {
        mediaConstraints: { audio: true, video: false }
      });

      currentSession = session;

      session.on('peerconnection', function(e) {
        const pc = e.peerconnection;
        if ('ontrack' in pc) {
          pc.ontrack = function(event) {
            if (event.streams && event.streams[0]) {
              audioRemote.srcObject = event.streams[0];
            }
          };
        } else {
          pc.onaddstream = function(event) {
            audioRemote.srcObject = event.stream;
          };
        }
      });

      session.on('progress', () => {
        console.log('📞 振铃中...');
        statusDiv.textContent = '状态：振铃中...';
      });

      session.on('accepted', () => {
        console.log('✅ 通话已接听');
        statusDiv.textContent = '状态：通话中';
        hangupBtn.style.display = 'inline-block';
      });

      session.on('ended', () => {
        console.log('🛑 通话结束');
        statusDiv.textContent = '状态：通话已结束';
        hangupBtn.style.display = 'none';
        currentSession = null;
      });

      session.on('failed', (e) => {
        console.error('❌ 呼叫失败', e);
        statusDiv.textContent = '状态：呼叫失败';
        hangupBtn.style.display = 'none';
        currentSession = null;
      });
    });

    hangupBtn.addEventListener('click', () => {
      if (currentSession) {
        currentSession.terminate();
        currentSession = null;
        statusDiv.textContent = '状态：通话已挂断';
        hangupBtn.style.display = 'none';
      }
    });
  </script>
</body>
</html>
