<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>WebRTC SIP æµ‹è¯•</title>
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>
</head>
<body>
  <h2>WebRTC æµ‹è¯•</h2>
  <button onclick="call()">å‘¼å« 6666</button>
  <button onclick="hangup()">æŒ‚æ–­</button>

  <!-- éŸ³é¢‘å…ƒç´  -->
  <audio id="remoteAudio" autoplay playsinline></audio>

  <script>
    let ua, session;

    // é…ç½® STUN æœåŠ¡å™¨ï¼ˆé€‚ç”¨äºä¸­å›½å¤§é™†ï¼‰
    const iceServers = [
      { urls: 'stun:stun.qq.com:3478' },
      { urls: 'stun:stun.miwifi.com:3478' },
      { urls: 'stun:stun.cdnbye.com:3478' }
    ];

    // è‡ªåŠ¨æ³¨å†Œåˆ†æœº
    window.onload = function() {
      const socket = new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
      const configuration = {
        sockets: [socket],
        uri: 'sip:1008600@xin.anjre.cn',
        password: 'Aa6363463',
        display_name: 'ç½‘é¡µåˆ†æœº',
        session_timers: false,
        iceServers: iceServers
      };

      ua = new JsSIP.UA(configuration);

      ua.on('registered', () => console.log('âœ… å·²æ³¨å†ŒæˆåŠŸ'));
      ua.on('registrationFailed', (e) => console.error('âŒ æ³¨å†Œå¤±è´¥', e));
      ua.on('newRTCSession', (data) => {
        session = data.session;

        session.on('ended', () => console.log('ğŸ“ é€šè¯ç»“æŸ'));
        session.on('accepted', () => console.log('ğŸ“ é€šè¯å·²æ¥é€š'));

        session.on('peerconnection', (e) => {
          const peerconnection = e.peerconnection;

          peerconnection.addEventListener('track', (event) => {
            const remoteStream = event.streams[0];
            const remoteAudio = document.getElementById('remoteAudio');
            remoteAudio.srcObject = remoteStream;
            remoteAudio.play().catch((error) => {
              console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
            });
          });
        });
      });

      ua.start();
    };

    function call() {
      if (!ua || ua.isRegistered() === false) {
        alert('å°šæœªæ³¨å†Œåˆ†æœºã€‚');
        return;
      }

      const eventHandlers = {
        progress: () => console.log('ğŸ“ å‘¼å«ä¸­...'),
        failed: (e) => console.error('âŒ å‘¼å«å¤±è´¥:', e.cause),
        ended: () => console.log('ğŸ“ é€šè¯ç»“æŸ'),
        confirmed: () => console.log('ğŸ“ é€šè¯å·²æ¥é€š')
      };

      const options = {
        eventHandlers,
        mediaConstraints: { audio: true, video: false },
        pcConfig: {
          iceServers: iceServers
        }
      };

      session = ua.call('sip:6666@xin.anjre.cn', options);

      // è®¾ç½® ICE å€™é€‰æ”¶é›†è¶…æ—¶ä¸º 5 ç§’
      const pc = session.connection;
      let iceGatheringTimeout = setTimeout(() => {
        if (pc.iceGatheringState !== 'complete') {
          console.warn('âš ï¸ ICE å€™é€‰æ”¶é›†è¶…æ—¶ï¼Œç»§ç»­å»ºç«‹è¿æ¥');
          // ç»§ç»­å»ºç«‹è¿æ¥çš„é€»è¾‘ï¼ˆå¦‚æœéœ€è¦ï¼‰
        }
      }, 5000);

      pc.addEventListener('icegatheringstatechange', () => {
        if (pc.iceGatheringState === 'complete') {
          clearTimeout(iceGatheringTimeout);
        }
      });
    }

    function hangup() {
      if (session) session.terminate();
    }
  </script>
</body>
</html>
