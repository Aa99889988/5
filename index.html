<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>JsSIP 移动端 SIP 通话示例</title>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script src="https://unpkg.com/jssip@3.10.1/dist/jssip.min.js"></script>
</head>
<body>
  <button id="callButton">呼叫客服</button>
  <button id="hangupButton" disabled>挂断</button>
  <p id="status">就绪</p>
  <audio id="remoteAudio" autoplay playsinline></audio>

<script>
// 初始化 JsSIP UA
const socket = new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
const configuration = {
  sockets: [socket],
  uri: 'sip:100110@xin.anjre.cn',
  password: 'Aa6363463@'
};
const ua = new JsSIP.UA(configuration);
ua.start();

// 获取页面元素
const callButton = document.getElementById('callButton');
const hangupButton = document.getElementById('hangupButton');
const statusElem = document.getElementById('status');
const remoteAudio = document.getElementById('remoteAudio');
let session = null;

// 点击“呼叫客服”按钮发起呼叫
callButton.addEventListener('click', () => {
  session = ua.call('sip:9901@xin.anjre.cn', {
    mediaConstraints: { audio: true, video: false },
    pcConfig: { iceServers: [] }  // 禁用 STUN/TURN
  });
  statusElem.innerText = '振铃中...';
  callButton.disabled = true;
  hangupButton.disabled = false;

  // 呼叫状态事件监听
  session.on('progress', () => {
    statusElem.innerText = '振铃中...';
  });
  session.on('confirmed', () => {
    statusElem.innerText = '通话中';
  });
  session.on('ended', () => {
    statusElem.innerText = '通话结束';
    callButton.disabled = false;
    hangupButton.disabled = true;
  });
  session.on('failed', (e) => {
    statusElem.innerText = '通话失败: ' + e.cause;
    callButton.disabled = false;
    hangupButton.disabled = true;
  });

  // 监听 PeerConnection 的 track 事件获取远端音频
  session.on('peerconnection', (e) => {
    const pc = e.peerconnection;
    pc.addEventListener('track', (ev) => {
      if (ev.track.kind === 'audio') {
        const stream = ev.streams[0] || new MediaStream([ev.track]);
        remoteAudio.srcObject = stream;
      }
    });
  });
});

// 点击“挂断”按钮结束通话
hangupButton.addEventListener('click', () => {
  if (session) {
    session.terminate();
  }
});
</script>
</body>
</html>
