<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ç½‘é¡µå‘¼å« SIP</title>
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>
</head>
<body>
  <h2>ç‚¹å‡»æŒ‰é’®æ‹¨æ‰“ SIP åˆ†æœº 9901</h2>
  <button onclick="makeCall()">ğŸ“ å‘¼å« 9901</button>
  <button onclick="hangUp()">ğŸ›‘ æŒ‚æ–­é€šè¯</button>

  <!-- è¿œç«¯éŸ³é¢‘æ’­æ”¾ -->
  <audio id="remoteAudio" autoplay></audio>
  <!-- æ¥ç”µå“é“ƒéŸ³ï¼ˆå¯è‡ªå®šä¹‰ ring.mp3ï¼‰ -->
  <audio id="ringtone" src="ring.mp3" preload="auto" style="display: none;"></audio>

  <script>
    const socket = new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
    const configuration = {
      sockets: [socket],
      uri: 'sip:100110@xin.anjre.cn',
      password: 'Aa6363463@',
      display_name: 'ç½‘é¡µå®¢æˆ·',
      session_timers: false,
      register: true
    };

    const ua = new JsSIP.UA(configuration);
    let currentSession = null;

    ua.on('connected', () => console.log('âœ… å·²è¿æ¥ SIP WebSocket'));
    ua.on('registered', () => console.log('âœ… æ³¨å†ŒæˆåŠŸ'));
    ua.on('registrationFailed', e => console.error('âŒ æ³¨å†Œå¤±è´¥', e));
    ua.on('disconnected', () => console.log('â— WebSocket å·²æ–­å¼€'));

    // æ¥ç”µå¤„ç†
    ua.on('newRTCSession', function(data) {
      const session = data.session;

      if (session.direction === 'incoming') {
        console.log('ğŸ“² æ”¶åˆ°æ¥ç”µ');
        const ringtone = document.getElementById('ringtone');
        ringtone.play();

        session.on('ended', () => {
          ringtone.pause();
          ringtone.currentTime = 0;
          console.log('ğŸ“´ æ¥ç”µç»“æŸ');
        });

        session.on('failed', () => {
          ringtone.pause();
          ringtone.currentTime = 0;
          console.log('âŒ æ¥ç”µå¤±è´¥');
        });

        // è‡ªåŠ¨æ¥å¬
        session.answer({
          mediaConstraints: { audio: true, video: false }
        });

        attachAudio(session);
        currentSession = session;
      }
    });

    ua.start();

    function makeCall() {
      const session = ua.call('sip:9901@xin.anjre.cn', {
        mediaConstraints: { audio: true, video: false }
      });

      session.on('progress', () => console.log('ğŸ“ å‘¼å«ä¸­...'));
      session.on('accepted', () => console.log('âœ… é€šè¯å·²æ¥å¬'));
      session.on('ended', () => console.log('ğŸ›‘ é€šè¯ç»“æŸ'));
      session.on('failed', e => console.error('âŒ å‘¼å«å¤±è´¥', e));

      attachAudio(session);
      currentSession = session;
    }

    function hangUp() {
      if (currentSession) {
        currentSession.terminate();
        console.log('ğŸ“´ é€šè¯å·²æŒ‚æ–­');
      }
    }

    function attachAudio(session) {
      session.connection.addEventListener('track', function(e) {
        const remoteAudio = document.getElementById('remoteAudio');
        if (remoteAudio.srcObject !== e.streams[0]) {
          remoteAudio.srcObject = e.streams[0];
        }
      });
    }
  </script>
</body>
</html>
