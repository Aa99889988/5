<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>WebRTC SIP 测试</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>
</head>
<body>
  <h2>WebRTC 测试</h2>
  <button onclick="call()">呼叫6666</button>
  <button onclick="hangup()">挂断</button>
  <audio id="remoteAudio" autoplay playsinline></audio>

  <script>
    let ua, session;

    function initialize() {
      const socket = new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
      const configuration = {
        sockets: [socket],
        uri: 'sip:1008600@xin.anjre.cn',
        password: 'Aa6363463',
        display_name: '网页分机',
        session_timers: false,
        register: true,
        pcConfig: {
          iceServers: [
            { urls: 'stun:stun.qq.com:3478' },
            { urls: 'stun:stun.miwifi.com:3478' },
            { urls: 'stun:stun.cdnbye.com:3478' }
          ]
        }
      };

      ua = new JsSIP.UA(configuration);

      ua.on('registered', () => console.log('✅ 已注册成功'));
      ua.on('registrationFailed', (e) => console.error('❌ 注册失败:', e.cause));
      ua.on('newRTCSession', (data) => {
        session = data.session;

        session.on('ended', () => console.log('📞 通话结束'));
        session.on('accepted', () => console.log('📞 通话已接通'));
        session.on('failed', (e) => console.error('❌ 通话失败:', e.cause));

        session.on('peerconnection', (e) => {
          const peerconnection = e.peerconnection;

          peerconnection.addEventListener('track', (event) => {
            const remoteStream = event.streams[0];
            const remoteAudio = document.getElementById('remoteAudio');
            remoteAudio.srcObject = remoteStream;
            remoteAudio.play().catch((error) => {
              console.error('🎧 音频播放失败:', error);
            });
          });
        });

        // 添加 ICE 候选收集超时处理
        session.connection.addEventListener('icegatheringstatechange', () => {
          if (session.connection.iceGatheringState === 'gathering') {
            // 设置超时为 5 秒
            setTimeout(() => {
              if (session.connection.iceGatheringState !== 'complete') {
                console.warn('⚠️ ICE 候选收集超时，继续建立连接');
                // 继续建立连接的逻辑（如果需要）
              }
            }, 5000);
          }
        });
      });

      ua.start();
    }

    function call() {
      if (!ua || ua.isRegistered() === false) {
        alert('请先注册分机。');
        return;
      }

      const eventHandlers = {
        progress: () => console.log('📞 呼叫中...'),
        failed: (e) => console.error('❌ 呼叫失败:', e.cause),
        ended: () => console.log('📞 通话结束'),
        confirmed: () => console.log('📞 通话已接通')
      };

      const options = {
        eventHandlers,
        mediaConstraints: { audio: true, video: false },
        pcConfig: {
          iceServers: [
            { urls: 'stun:stun.qq.com:3478' },
            { urls: 'stun:stun.miwifi.com:3478' },
            { urls: 'stun:stun.cdnbye.com:3478' }
          ]
        }
      };

      session = ua.call('sip:6666@xin.anjre.cn', options);
    }

    function hangup() {
      if (session) {
        session.terminate();
        console.log('📞 通话已挂断');
      }
    }

    // 页面加载完成后初始化
    window.addEventListener('load', initialize);
  </script>
</body>
</html>
