<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç½‘é¡µè¯­éŸ³å‘¼å«å®¢æœ</title>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="https://unpkg.com/jssip@3.10.1/dist/jssip.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #f2f2f2;
      font-family: sans-serif;
      height: 100vh;
    }
    .container {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    button {
      font-size: 20px;
      padding: 16px 36px;
      margin: 12px;
      border: none;
      border-radius: 12px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      width: 80%;
      max-width: 300px;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    #status {
      margin-top: 24px;
      font-size: 18px;
      color: #333;
      text-align: center;
    }
  </style>
</head>
<body>

  <div class="container">
    <button id="callBtn">ğŸ“ å‘¼å«å®¢æœ</button>
    <button id="hangupBtn" disabled>ğŸ›‘ æŒ‚æ–­</button>
    <div id="status">çŠ¶æ€ï¼šç­‰å¾…å‘¼å«</div>
    <audio id="remoteAudio" autoplay playsinline></audio>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const callBtn = document.getElementById("callBtn");
      const hangupBtn = document.getElementById("hangupBtn");
      const statusDiv = document.getElementById("status");
      const remoteAudio = document.getElementById("remoteAudio");

      const socket = new JsSIP.WebSocketInterface("wss://xin.anjre.cn:8089/ws");
      const ua = new JsSIP.UA({
        sockets: [socket],
        uri: "sip:100110@xin.anjre.cn",
        password: "Aa6363463@"
      });

      ua.on("registered", () => {
        console.log("âœ… SIP æ³¨å†ŒæˆåŠŸ");
        statusDiv.innerText = "çŠ¶æ€ï¼šå·²æ³¨å†Œï¼Œå‡†å¤‡å‘¼å«";
      });

      ua.on("registrationFailed", (e) => {
        console.error("âŒ æ³¨å†Œå¤±è´¥", e);
        statusDiv.innerText = "çŠ¶æ€ï¼šæ³¨å†Œå¤±è´¥";
      });

      ua.start();

      let session = null;

      callBtn.addEventListener("click", () => {
        if (session) return;

        session = ua.call("sip:9901@xin.anjre.cn", {
          mediaConstraints: { audio: true, video: false },
          pcConfig: { iceServers: [] } // æ—  STUN / TURN
        });

        statusDiv.innerText = "çŠ¶æ€ï¼šæ­£åœ¨å‘¼å«...";
        callBtn.disabled = true;
        hangupBtn.disabled = false;

        session.on("progress", () => statusDiv.innerText = "çŠ¶æ€ï¼šå¯¹æ–¹æŒ¯é“ƒä¸­...");
        session.on("confirmed", () => statusDiv.innerText = "çŠ¶æ€ï¼šé€šè¯ä¸­");
        session.on("ended", () => reset("çŠ¶æ€ï¼šé€šè¯ç»“æŸ"));
        session.on("failed", (e) => {
          console.error("å‘¼å«å¤±è´¥", e);
          reset("çŠ¶æ€ï¼šå‘¼å«å¤±è´¥");
        });

        session.on("peerconnection", ({ peerconnection }) => {
          peerconnection.addEventListener("track", (ev) => {
            if (ev.track.kind === "audio") {
              const stream = ev.streams[0];
              remoteAudio.srcObject = stream;
            }
          });
        });
      });

      hangupBtn.addEventListener("click", () => {
        if (session) session.terminate();
      });

      function reset(msg) {
        session = null;
        callBtn.disabled = false;
        hangupBtn.disabled = true;
        statusDiv.innerText = msg;
      }
    });
  </script>
</body>
</html>
